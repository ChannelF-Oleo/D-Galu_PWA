rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // ===== HELPER FUNCTIONS =====
    
    // Get user role from custom claims (preferred) or Firestore document
    function getUserRole() {
      return request.auth != null && request.auth.token.role != null ? 
             request.auth.token.role : 
             (request.auth != null ? 
              firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role : 
              null);
    }
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Role-based permission checks
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    function isManager() {
      return isAuthenticated() && getUserRole() == 'manager';
    }
    
    function isStaff() {
      return isAuthenticated() && getUserRole() == 'staff';
    }
    
    function isCustomer() {
      return isAuthenticated() && getUserRole() == 'customer';
    }
    
    function isStudent() {
      return isAuthenticated() && getUserRole() == 'student';
    }
    
    // Combined role checks
    function isManagerOrAbove() {
      return isAdmin() || isManager();
    }
    
    function isStaffOrAbove() {
      return isAdmin() || isManager() || isStaff();
    }
    
    // File validation functions
    function isValidImageFile() {
      return (
        // Verificar tipo MIME de imagen O application/octet-stream (fallback común)
        (request.resource.contentType.matches('image/.*') || 
         request.resource.contentType == 'application/octet-stream') &&
        // Verificar tamaño (Menor a 10MB y mayor a 0)
        request.resource.size < 10 * 1024 * 1024 && 
        request.resource.size > 0
      );
    }
    
    function isValidDocumentFile() {
      return request.resource.contentType in ['application/pdf', 'application/msword', 
                                              'application/vnd.openxmlformats-officedocument.wordprocessingml.document'] &&
             request.resource.size < 50 * 1024 * 1024; // 50MB limit for documents
    }
    
    function isValidVideoFile() {
      return request.resource.contentType.matches('video/.*') &&
             request.resource.size < 500 * 1024 * 1024; // 500MB limit for videos
    }

    // ================================================================
    // REGLAS DE CARPETAS (Aquí es donde se define la lectura/escritura)
    // ================================================================

    // ===== SERVICES FOLDER =====
    match /services/{allPaths=**} {
      // DEBUGGING: COMPLETAMENTE ABIERTO - SIN RESTRICCIONES
      allow read, write, delete: if true;
    }

    // ===== PRODUCTS FOLDER =====
    match /products/{allPaths=**} {
      // DEBUGGING: COMPLETAMENTE ABIERTO - SIN RESTRICCIONES  
      allow read, write, delete: if true;
    }

    // ===== COURSES FOLDER =====
    match /courses/{allPaths=**} {
      allow read: if isStudent() || isAdmin();
      allow write: if isAdmin() && (isValidImageFile() || isValidDocumentFile() || isValidVideoFile());
      allow delete: if isAdmin();
    }

    // ===== GALLERY FOLDER =====
    match /gallery/{allPaths=**} {
      allow read: if true;
      allow write: if isStaffOrAbove() && isValidImageFile();
      allow delete: if isManagerOrAbove();
    }

    // ===== USERS FOLDER =====
    match /users/{userId}/{allPaths=**} {
      allow read: if true;
      // Usuario dueño o Admin
      allow write: if (isAuthenticated() && request.auth.uid == userId && isValidImageFile()) || 
                      isAdmin();
      allow delete: if (isAuthenticated() && request.auth.uid == userId) || isAdmin();
    }

    // ===== AVATARS FOLDER =====
    match /avatars/{allPaths=**} {
      allow read: if true;
      // Cualquier usuario autenticado puede subir su avatar
      allow write: if isAuthenticated() && isValidImageFile();
      allow delete: if isAuthenticated() || isAdmin();
    }

    // ===== BOOKINGS FOLDER =====
    match /bookings/{bookingId}/{allPaths=**} {
      allow read: if isStaffOrAbove();
      allow write: if isStaffOrAbove() && (isValidImageFile() || isValidDocumentFile());
      allow delete: if isManagerOrAbove();
    }

    // ===== NOTIFICATIONS FOLDER =====
    match /notifications/{allPaths=**} {
      allow read: if isStaffOrAbove();
      allow write: if isStaffOrAbove() && isValidImageFile();
      allow delete: if isAdmin();
    }

    // ===== SYSTEM FOLDER =====
    match /system/{allPaths=**} {
      allow read: if isAdmin();
      allow write: if isAdmin();
      allow delete: if isAdmin();
    }

    // ===== TEMP FOLDER =====
    match /temp/{userId}/{allPaths=**} {
      allow read: if (isAuthenticated() && request.auth.uid == userId) || isAdmin();
      allow write: if isAuthenticated() && request.auth.uid == userId && 
                      (isValidImageFile() || isValidDocumentFile());
      allow delete: if (isAuthenticated() && request.auth.uid == userId) || isAdmin();
    }

    // ===== UPLOADS FOLDER =====
    match /uploads/{allPaths=**} {
      allow read: if isStaffOrAbove();
      allow write: if isStaffOrAbove() && isValidImageFile();
      allow delete: if isManagerOrAbove();
    }

    // ===== DEFAULT DENY =====
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}