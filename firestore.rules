rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== HELPER FUNCTIONS =====
    
    // Get user role from custom claims (preferred) or document
    function getUserRole() {
      return request.auth.token.get('role', null) != null ? request.auth.token.role : 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Fallback function to get role directly from user document
    function getUserRoleFromDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Role-based permission checks with fallback
    function isAdmin() {
      return isAuthenticated() && (
        (request.auth.token.get('role', null) != null && request.auth.token.role == 'admin') ||
        getUserRoleFromDoc() == 'admin'
      );
    }
    
    function isManager() {
      return isAuthenticated() && (
        (request.auth.token.get('role', null) != null && request.auth.token.role == 'manager') ||
        getUserRoleFromDoc() == 'manager'
      );
    }
    
    function isStaff() {
      return isAuthenticated() && (
        (request.auth.token.get('role', null) != null && request.auth.token.role == 'staff') ||
        getUserRoleFromDoc() == 'staff'
      );
    }
    
    function isCustomer() {
      return isAuthenticated() && (
        (request.auth.token.get('role', null) != null && request.auth.token.role == 'customer') ||
        getUserRoleFromDoc() == 'customer'
      );
    }
    
    function isStudent() {
      return isAuthenticated() && (
        (request.auth.token.get('role', null) != null && request.auth.token.role == 'student') ||
        getUserRoleFromDoc() == 'student'
      );
    }
    
    // Combined role checks
    function isManagerOrAbove() {
      return isAdmin() || isManager();
    }
    
    function isStaffOrAbove() {
      return isAdmin() || isManager() || isStaff();
    }
    
    // Validate required fields for different document types
    function hasRequiredUserFields() {
      return request.resource.data.keys().hasAll(['email', 'role', 'createdAt']) &&
             request.resource.data.role in ['admin', 'manager', 'staff', 'customer', 'student'];
    }
    
    function hasRequiredServiceFields() {
      return request.resource.data.keys().hasAll(['name', 'price', 'duration', 'category']) &&
             request.resource.data.price is number && request.resource.data.price >= 0 &&
             request.resource.data.duration is number && request.resource.data.duration > 0;
    }
    
    function hasRequiredProductFields() {
      return request.resource.data.keys().hasAll(['name', 'price', 'stock', 'category']) &&
             request.resource.data.price is number && request.resource.data.price >= 0 &&
             request.resource.data.stock is number && request.resource.data.stock >= 0;
    }
    
    function hasRequiredBookingFields() {
      return request.resource.data.keys().hasAll(['customerName', 'customerEmail', 'date', 'time', 'services', 'status']) &&
             request.resource.data.customerEmail is string &&
             request.resource.data.status in ['pending', 'confirmed', 'cancelled', 'completed'] &&
             request.resource.data.services is list && request.resource.data.services.size() > 0;
    }

    // ===== USERS COLLECTION =====
    match /users/{userId} {
      // Read: Users can read their own profile, staff+ can read all
      allow read: if isOwner(userId) || isStaffOrAbove() || isAdmin();
      
      // Create: Authenticated users can create their own profile or admin can create any
      allow create: if (isAuthenticated() && request.auth.uid == userId) || isAdmin();
      
      // Update: Users can update their own profile (limited fields), admin can update all
      allow update: if isOwner(userId) && 
                       // Users can only update these fields
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['displayName', 'phone', 'preferences', 'updatedAt']) ||
                    isAdmin();
      
      // Delete: Only admin can delete users
      allow delete: if isAdmin();
    }

    // ===== SERVICES COLLECTION =====
    match /services/{serviceId} {
      // Read: Public access for active services, staff+ can read all, admin can read all
      allow read: if true; // Temporary: allow all reads for debugging
      
      // Write: Manager+ can create/update services, admin has full access
      allow create: if isManagerOrAbove() || isAdmin();
      allow update: if isManagerOrAbove() || isAdmin();
      
      // Delete: Only admin can delete services
      allow delete: if isAdmin();
    }

    // ===== PRODUCTS COLLECTION =====
    match /products/{productId} {
      // Read: Public access for active products, staff+ can read all, admin can read all
      allow read: if true; // Temporary: allow all reads for debugging
      
      // Write: Manager+ can create/update products, admin has full access
      allow create: if isManagerOrAbove() || isAdmin();
      allow update: if isManagerOrAbove() || isAdmin();
      
      // Delete: Only admin can delete products
      allow delete: if isAdmin();
    }

    // ===== BOOKINGS COLLECTION =====
    match /bookings/{bookingId} {
      // Read: Customers can read their own bookings, staff+ can read all, admin can read all
      allow read: if isAuthenticated(); // Temporary: allow all authenticated reads for debugging
      
      // Create: Authenticated users can create bookings, admin has full access
      allow create: if isAuthenticated() || isAdmin();
      
      // Update: Staff+ can update any booking, customers can update their own, admin has full access
      allow update: if isStaffOrAbove() || isAdmin() ||
                       (isCustomer() && resource.data.userId == request.auth.uid);
      
      // Delete: Only admin can delete bookings
      allow delete: if isAdmin();
    }

    // ===== COURSES COLLECTION =====
    match /courses/{courseId} {
      // Read: Public access for active courses, admin can read all
      allow read: if resource.data.isActive == true || isAdmin();
      
      // Write: Only admin can manage courses
      allow create, update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ===== COURSE ENROLLMENTS =====
    match /course_enrollments/{enrollmentId} {
      // Read: Students can read their own enrollments, admin can read all
      allow read: if (isStudent() && resource.data.userId == request.auth.uid) || isAdmin();
      
      // Create: Students can enroll themselves, admin can enroll anyone
      allow create: if (isStudent() && request.resource.data.userId == request.auth.uid) || isAdmin();
      
      // Update/Delete: Only admin
      allow update, delete: if isAdmin();
    }

    // ===== GALLERY COLLECTION =====
    match /gallery/{imageId} {
      // Read: Public access
      allow read: if true;
      
      // Write: Staff+ can upload gallery images
      allow create, update: if isStaffOrAbove();
      allow delete: if isManagerOrAbove();
    }

    // ===== NOTIFICATIONS COLLECTION =====
    match /notifications/{notificationId} {
      // Read: Authenticated users can read notifications, admin can read all
      allow read: if isAuthenticated(); // Temporary: allow all authenticated reads for debugging
      
      // Create: Staff+ can create notifications, admin has full access
      allow create: if isStaffOrAbove() || isAdmin();
      
      // Update: Users can mark their notifications as read, staff+ can update all, admin has full access
      allow update: if isAuthenticated() || isStaffOrAbove() || isAdmin();
      
      // Delete: Only admin can delete notifications
      allow delete: if isAdmin();
    }

    // ===== SYSTEM LOGS COLLECTION =====
    match /system_logs/{logId} {
      // Read: Only admin can read system logs
      allow read: if isAdmin();
      
      // Create: System can create logs (Cloud Functions)
      allow create: if true;
      
      // Update/Delete: Only admin
      allow update, delete: if isAdmin();
    }

    // ===== STUDENTS COLLECTION (Legacy/Separate from Users) =====
    match /students/{studentId} {
      // Read: Students can read their own data, admin can read all
      allow read: if (isStudent() && resource.data.userId == request.auth.uid) || isAdmin();
      
      // Write: Only admin can manage student records
      allow create, update, delete: if isAdmin();
    }

    // ===== DEFAULT DENY =====
    // Any collection not explicitly defined above is denied by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}